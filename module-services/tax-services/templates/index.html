{% extends "base.html" %}

{% block title %}Tax Services Dashboard{% endblock %}

{% block content %}
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 30px;">
    <div class="card metric-card">
        <span class="metric-value">{{ "%.2f" | format(tax_rates.state_tax_rate * 100) if tax_rates else "0.00" }}%</span>
        <span class="metric-label">Current State Tax Rate</span>
    </div>
    
    <div class="card metric-card">
        <span class="metric-value">{{ "%.2f" | format(tax_rates.federal_tax_rate * 100) if tax_rates else "0.00" }}%</span>
        <span class="metric-label">Current Federal Tax Rate</span>
    </div>
    
    <div class="card metric-card">
        <span class="metric-value">{{ calculations|length }}</span>
        <span class="metric-label">Recent Calculations</span>
    </div>
</div>

<div class="card">
    <h3>Current Tax Configuration</h3>
    {% if tax_rates %}
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-top: 15px;">
        <div>
            <div class="form-label">State Tax Rate</div>
            <div style="font-size: 1.5rem; font-weight: 600; color: #667eea;">
                {{ "%.4f" | format(tax_rates.state_tax_rate) }} ({{ "%.2f" | format(tax_rates.state_tax_rate * 100) }}%)
            </div>
        </div>
        
        <div>
            <div class="form-label">Federal Tax Rate</div>
            <div style="font-size: 1.5rem; font-weight: 600; color: #667eea;">
                {{ "%.4f" | format(tax_rates.federal_tax_rate) }} ({{ "%.2f" | format(tax_rates.federal_tax_rate * 100) }}%)
            </div>
        </div>
        
        <div>
            <div class="form-label">Last Updated</div>
            <div style="font-size: 1rem; color: #6b7280;">
                {{ tax_rates.updated_at.strftime('%Y-%m-%d %H:%M:%S') if tax_rates.updated_at else 'Unknown' }}
            </div>
        </div>
        
        <div>
            <div class="form-label">Updated By</div>
            <div style="font-size: 1rem; color: #6b7280;">
                {{ tax_rates.updated_by or 'System' }}
            </div>
        </div>
    </div>
    
    <div style="margin-top: 20px;">
        <a href="/rates" class="btn">Update Tax Rates</a>
    </div>
    {% else %}
    <p style="color: #6b7280; margin-top: 15px;">No tax rates configured. Please set up tax rates to begin processing claims.</p>
    <div style="margin-top: 20px;">
        <a href="/rates" class="btn">Configure Tax Rates</a>
    </div>
    {% endif %}
</div>

<div class="card">
    <h3>Recent Tax Calculations</h3>
    {% if calculations %}
    <div style="overflow-x: auto;">
        <table class="table">
            <thead>
                <tr>
                    <th>Claim ID</th>
                    <th>Wages</th>
                    <th>State Tax</th>
                    <th>Federal Tax</th>
                    <th>Total Tax</th>
                    <th>Calculated</th>
                </tr>
            </thead>
            <tbody>
                {% for calc in calculations %}
                <tr>
                    <td style="font-family: monospace; font-weight: 600;">{{ calc.claim_id }}</td>
                    <td>${{ "%.2f" | format(calc.wages) }}</td>
                    <td>
                        <div>${{ "%.2f" | format(calc.state_tax_amount) }}</div>
                        <div style="font-size: 0.8rem; color: #6b7280;">
                            ({{ "%.2f" | format(calc.state_tax_rate * 100) }}%)
                        </div>
                    </td>
                    <td>
                        <div>${{ "%.2f" | format(calc.federal_tax_amount) }}</div>
                        <div style="font-size: 0.8rem; color: #6b7280;">
                            ({{ "%.2f" | format(calc.federal_tax_rate * 100) }}%)
                        </div>
                    </td>
                    <td style="font-weight: 600; color: #667eea;">
                        ${{ "%.2f" | format(calc.total_tax_amount) }}
                    </td>
                    <td style="font-size: 0.9rem; color: #6b7280;">
                        {{ calc.calculated_at.strftime('%m/%d %H:%M') if calc.calculated_at else 'Unknown' }}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <p style="color: #6b7280; margin-top: 15px;">No tax calculations performed yet. The service will automatically process claims as they become available.</p>
    {% endif %}
</div>

<div class="card">
    <h3>Service Status</h3>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 15px;">
        <div style="padding: 15px; background: #f0fff4; border: 1px solid #86efac; border-radius: 8px;">
            <div style="font-weight: 600; color: #065f46;">Database Connection</div>
            <div style="color: #16a34a; font-size: 0.9rem;">âœ… Connected</div>
        </div>
        
        <div style="padding: 15px; background: #f0f9ff; border: 1px solid #7dd3fc; border-radius: 8px;">
            <div style="font-weight: 600; color: #0c4a6e;">Gateway Registration</div>
            <div style="color: #0284c7; font-size: 0.9rem;">ðŸ”— Registered</div>
        </div>
        
        <div style="padding: 15px; background: #fefce8; border: 1px solid #fde047; border-radius: 8px;">
            <div style="font-weight: 600; color: #713f12;">Polling Status</div>
            <div style="color: #a16207; font-size: 0.9rem;">ðŸ”„ Active</div>
        </div>
        
        <div style="padding: 15px; background: #f3e8ff; border: 1px solid #c084fc; border-radius: 8px;">
            <div style="font-weight: 600; color: #581c87;">SOAP Endpoint</div>
            <div style="color: #7c3aed; font-size: 0.9rem;">ðŸ“¡ Ready</div>
        </div>
    </div>
</div>

<div class="card">
    <h3>How Tax Services Works</h3>
    <div style="margin-top: 15px;">
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
            <div style="padding: 20px; background: #f8fafc; border-radius: 8px; border-left: 4px solid #667eea;">
                <div style="font-weight: 600; color: #374151; margin-bottom: 8px;">1. Poll for Claims</div>
                <div style="color: #6b7280; font-size: 0.9rem;">
                    Continuously polls camel-gateway for claims with status 'AWAITING_TAX_CALCULATION'
                </div>
            </div>
            
            <div style="padding: 20px; background: #f8fafc; border-radius: 8px; border-left: 4px solid #667eea;">
                <div style="font-weight: 600; color: #374151; margin-bottom: 8px;">2. Calculate Taxes</div>
                <div style="color: #6b7280; font-size: 0.9rem;">
                    Applies current state and federal tax rates to reported wages
                </div>
            </div>
            
            <div style="padding: 20px; background: #f8fafc; border-radius: 8px; border-left: 4px solid #667eea;">
                <div style="font-weight: 600; color: #374151; margin-bottom: 8px;">3. Store Results</div>
                <div style="color: #6b7280; font-size: 0.9rem;">
                    Saves calculation details to PostgreSQL database for audit trail
                </div>
            </div>
            
            <div style="padding: 20px; background: #f8fafc; border-radius: 8px; border-left: 4px solid #667eea;">
                <div style="font-weight: 600; color: #374151; margin-bottom: 8px;">4. Send via SOAP</div>
                <div style="color: #6b7280; font-size: 0.9rem;">
                    Transmits tax amounts back to camel-gateway using SOAP protocol
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}