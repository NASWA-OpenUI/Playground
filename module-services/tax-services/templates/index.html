{% extends "base.html" %}

{% block title %}NASWA | Tax Services - Dashboard{% endblock %}

{% block content %}
<!-- Status Overview Cards -->
<div class="status-overview">
    <div class="status-card">
        <div class="status-label">Service Status</div>
        <div class="status-value">ONLINE</div>
        <div class="status-subtext">Processing Ready</div>
    </div>
    <div class="status-card">
        <div class="status-label">Technology</div>
        <div class="status-value">Python</div>
        <div class="status-subtext">Flask + PostgreSQL</div>
    </div>
    <div class="status-card">
        <div class="status-label">State Tax Rate</div>
        <div class="status-value">{{ "%.2f"|format(tax_rates.state_tax_rate * 100) if tax_rates else "2.00" }}%</div>
        <div class="status-subtext">Current Rate</div>
    </div>
    <div class="status-card">
        <div class="status-label">Federal Tax Rate</div>
        <div class="status-value">{{ "%.2f"|format(tax_rates.federal_tax_rate * 100) if tax_rates else "0.60" }}%</div>
        <div class="status-subtext">Current Rate</div>
    </div>
</div>

<!-- Recent Tax Calculations Table -->
<div class="table-container">
    <h3>Recent Tax Calculations</h3>
    
    {% if calculations %}
    <table class="table">
        <thead>
            <tr>
                <th>Claim ID</th>
                <th>Wages</th>
                <th>State Tax</th>
                <th>Federal Tax</th>
                <th>Total Tax</th>
                <th>Calculated</th>
            </tr>
        </thead>
        <tbody>
            {% for calc in calculations %}
            <tr>
                <td>{{ calc.claim_id }}</td>
                <td>${{ "{:,.2f}".format(calc.wages) }}</td>
                <td>${{ "{:,.2f}".format(calc.state_tax_amount) }}</td>
                <td>${{ "{:,.2f}".format(calc.federal_tax_amount) }}</td>
                <td><strong>${{ "{:,.2f}".format(calc.total_tax_amount) }}</strong></td>
                <td>{{ calc.calculated_at.strftime('%m/%d %H:%M') }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <div style="text-align: center; padding: 2rem; color: #666;">
        <p>No tax calculations processed yet.</p>
        <p style="font-size: 0.9rem; margin-top: 0.5rem;">Tax calculations will appear here as claims are processed.</p>
    </div>
    {% endif %}
</div>

<!-- Service Information Cards -->
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; margin-top: 2rem;">
    <div class="form-container" style="margin-bottom: 0;">
        <h3 style="color: var(--primary-color); margin-bottom: 1rem;">Service Overview</h3>
        <p style="color: #666; line-height: 1.6;">
            This tax calculation service processes unemployment insurance claims by computing state and federal tax obligations. 
            The service automatically polls for claims awaiting tax calculation and returns results via SOAP integration.
        </p>
    </div>
    
    <div class="form-container" style="margin-bottom: 0;">
        <h3 style="color: var(--primary-color); margin-bottom: 1rem;">Current Configuration</h3>
        {% if tax_rates %}
        <div style="display: flex; flex-direction: column; gap: 0.5rem;">
            <div style="display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid #f1f3f4;">
                <span style="font-weight: 500;">State Tax Rate:</span>
                <span>{{ "%.4f"|format(tax_rates.state_tax_rate) }} ({{ "%.2f"|format(tax_rates.state_tax_rate * 100) }}%)</span>
            </div>
            <div style="display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid #f1f3f4;">
                <span style="font-weight: 500;">Federal Tax Rate:</span>
                <span>{{ "%.4f"|format(tax_rates.federal_tax_rate) }} ({{ "%.2f"|format(tax_rates.federal_tax_rate * 100) }}%)</span>
            </div>
            <div style="display: flex; justify-content: space-between; padding: 0.5rem 0;">
                <span style="font-weight: 500;">Last Updated:</span>
                <span>{{ tax_rates.updated_at.strftime('%m/%d/%Y %H:%M') }}</span>
            </div>
        </div>
        <div style="text-align: center; margin-top: 1rem;">
            <a href="/rates" class="btn" style="text-decoration: none;">Manage Tax Rates</a>
        </div>
        {% else %}
        <p style="color: #666;">No tax rates configured.</p>
        <div style="text-align: center; margin-top: 1rem;">
            <a href="/rates" class="btn" style="text-decoration: none;">Configure Rates</a>
        </div>
        {% endif %}
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Auto-refresh the page every 30 seconds to show new calculations
    setInterval(function() {
        // Only refresh if there are calculations and the page is visible
        if (document.visibilityState === 'visible' && {{ 'true' if calculations else 'false' }}) {
            window.location.reload();
        }
    }, 30000);
    
    // Add some visual feedback for hovering over calculation rows
    const tableRows = document.querySelectorAll('.table tbody tr');
    tableRows.forEach(row => {
        row.addEventListener('mouseenter', function() {
            this.style.backgroundColor = '#f8f9fa';
        });
        row.addEventListener('mouseleave', function() {
            this.style.backgroundColor = '';
        });
    });
});
</script>

{% endblock %}
